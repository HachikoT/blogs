- [包管理](#包管理)
  - [包查找顺序](#包查找顺序)
  - [go.mod中间接引入包](#gomod中间接引入包)
  - [多个依赖包依赖同一个包的不同版本](#多个依赖包依赖同一个包的不同版本)
  - [包初始化顺序](#包初始化顺序)
- [参考资料](#参考资料)

# 包管理

## 包查找顺序

这里只讨论`GO111MODULE=on`的情况，依赖包查找顺序

1. 先从项目本地的vendor目录查找，没找到再从`${GOPATH}/pkg/mod`目录查找，得到结果一。
2. 同时也会从`${GOROOT}/src`标准库目录查找，得到结果二。
3. 同时也会从项目子目录查找（会加上项目名作为前缀），得到结果三。

如果只有一个结果，那么就正常编译，如果有多个结果就会报错包冲突。

## go.mod中间接引入包

`go.mod`中会记录项目的依赖包以及其版本信息，但有时候有些依赖包后面会添加`// indirect`注释，表明这是一个间接依赖。

间接依赖产生的原因是

1. 直接依赖包没有`go.mod`文件。
2. 直接依赖包有`go.mod`文件，但是里面记录的依赖包不全。

这个时候`go.mod`就会自动记录间接依赖包，并自动为其选择一个版本。

## 多个依赖包依赖同一个包的不同版本

当多个依赖包依赖同一个包的不同版本，例如包A依赖包C的v1.0.0版本，包B依赖包C的v2.0.0版本。

go构建时会按照高位兼容原则，取依赖包的v2.0.0版本。如果C未实现向前兼容，构建会报错。

## 包初始化顺序

go语言标准规定了多个编译单元的初始化顺序，包的初始化顺序按照包引入的顺序进行初始化，如果有依赖关系先解决依赖关系，按依赖的顺序进行初始化。

- 如果某个包被多次导入的话，也只会初始化一次。
- 对于同一个包中的多个`.go`文件，实现一般按照文件名排序，进行初始化
- 首先按顺序初始化全局常量和变量，如果有依赖关系先解决依赖关系，按依赖的顺序进行初始化
- 再调用`init`函数进行初始化

并且go语言是不允许包循环引用的，也不允许全局常量变量循环引用。

# 参考资料

- [Golang 初始化顺序](http://jiankunking.com/golang-package-init-order.html)
